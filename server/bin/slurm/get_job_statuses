#!/bin/bash

now=$(date +"%Y-%m-%d_%H-%M-%S-%N")
tmp_file="/tmp/$(basename $0).$$.tmp"
absolute_path=$(cd `dirname "${BASH_SOURCE[0]}"` && pwd)/`basename "${BASH_SOURCE[0]}"`

touch ${tmp_file}

trap 'rm -f ${tmp_file}' INT TERM EXIT

squeue -o "%.40i %.2t" > ${tmp_file}
rc=${?}

if [ "${rc}" != "0" ]; then
  echo "There was a problem getting job states: squeue returned non-zero exit code ${rc}." >&2
  exit 1
fi

cmd="cat ${tmp_file} | tail -n +2 | sed -e 's/^[[:space:]]*//' | tr -s ' ' | cut -d' ' -f1,2 | grep -v ' C$' | grep -v ' CA$'"

num_lines=$(eval ${cmd} | wc -l)
if [ "${num_lines}" == "0" ]; then
  echo "There was a problem getting job states: squeue did not return output." >&2
  exit 1
fi

eval ${cmd}